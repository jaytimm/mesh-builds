---
title: "Untitled"
output: html_document
date: '2022-11-05'
---



```{r eval=FALSE}
library(dplyr)
supps <- 'download/supp2022.gz' |> gzfile() |> xml2::read_xml()

## SupplementalRecordUI	SupplementalRecordName	SCRClass
SupplementalRecord <- supps %>%
  xml2::xml_find_all('.//SupplementalRecord')

srui <- SupplementalRecord |> 
  xml2::xml_find_all('.//SupplementalRecordUI') |> 
  xml2::xml_text()

class <- SupplementalRecord |> 
  # xml2::xml_find_all('.//SCRClass') |> 
  # xml2::xml_text()
  xml2::xml_attrs() 
```



```{r eval=FALSE}
SupplementalRecordUI <- supps |> 
  xml2::xml_find_all('.//SupplementalRecordUI') |> 
  xml2::xml_text()

SupplementalRecordName <- supps |> 
  xml2::xml_find_all('.//SupplementalRecordName') |>  
  xml2::xml_text() 

descriptor <- data.frame(SupplementalRecordUI, SupplementalRecordName) |>
  distinct() |> 
  arrange(SupplementalRecordUI)


rpt <- supps |> 
  xml2::xml_find_all('.//Term') |> 
  xml2::xml_attrs() 

rpt0 <- do.call(rbind.data.frame, rpt)
colnames(rpt0) <- names(rpt[[1]])

## Terms
TermUI <- supps |> 
  xml2::xml_find_all('.//TermUI') |>  
  xml2::xml_text() 

TermName <- supps |> 
  xml2::xml_find_all('.//Term') |>  
  xml2::xml_find_all('String') |>
  xml2::xml_text()

term <- data.frame(TermUI, TermName, rpt0) 


## Concepts
ConceptName <- supps |> 
  xml2::xml_find_all('.//ConceptName') |>  
  xml2::xml_text()

ConceptUI <- supps |> 
  xml2::xml_find_all('.//ConceptUI') |>  
  xml2::xml_text()

concept <- data.frame(ConceptUI, ConceptName)


remove(SupplementalRecordUI, SupplementalRecordName,
       rpt, rpt0)


concept_term <- term |>
  
  left_join(concept, by = c('TermName' = 'ConceptName')) |>
  tidyr::fill(ConceptUI) |>
  
  left_join(descriptor, by = c('TermName' = 'SupplementalRecordName')) |>
  
  mutate(SupplementalRecordName = ifelse(is.na(SupplementalRecordUI), NA, TermName)) |>
  
  tidyr::fill(SupplementalRecordUI, SupplementalRecordName) |>
  
  select(SupplementalRecordUI, SupplementalRecordName, ConceptUI,
         TermUI, TermName, 
         ConceptPreferredTermYN:RecordPreferredTermYN) |>
  
  ## bind_cols(rpt0) |>
  data.table::setDT()


saveRDS(concept_term, 'data/data_src_thesaurus.rds')
```

```{r}
# HeadingMappedToList <- supps %>% 
#     xml2::xml_find_all('.//HeadingMappedToList') %>% 
#     xml2::xml_text()
# 
# pa <- supps %>% 
#     xml2::xml_find_all('.//PharmacologicalAction') %>% 
#     xml2::xml_text()
# 
# source <- supps %>% 
#     xml2::xml_find_all('.//Source') %>% 
#     xml2::xml_text()
# 
# 
# srt <- lapply(SupplementalRecord[1:10], function(x){
#   
#   srui <- x %>% 
#     xml2::xml_find_all('.//SupplementalRecordUI') %>% 
#     xml2::xml_text()
#   
#   dui <- x %>% 
#     xml2::xml_find_all('.//DescriptorUI') %>% 
#     xml2::xml_text()
#   
#   casn <- x %>% 
#     xml2::xml_find_all('.//CASN1Name') %>% 
#     xml2::xml_text()
#   
#   hm2l <- x %>% 
#     xml2::xml_find_all('.//HeadingMappedToList') %>% 
#     xml2::xml_text()
#   
#   list(srui, dui, casn, hm2l)
# })
# 
# 
# qsrc <- data.frame(#SupplementalRecord,
#                   SupplementalRecordUI, 
#                   SupplementalRecordName,
#                   HeadingMappedToList) %>%
#   distinct() %>% 
#   arrange(SupplementalRecordUI)
```



